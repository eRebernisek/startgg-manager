<div class="matches-container">
  <h1>Sets</h1>
  <p class="subtitle">Recent and upcoming sets</p>
  
  <div *ngIf="isLoading" class="loading">
    <p>Loading tournaments and events...</p>
  </div>

  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
    <button (click)="loadTournaments()">Retry</button>
  </div>

  <div *ngIf="!isLoading && !error">

    <div class="tournament-selector" *ngIf="tournaments.length > 0">
      <label for="tournament-select">Select tournament:</label>
      <div class="tournament-selector-controls">
        <select id="tournament-select" [value]="selectedTournamentId || ''" (change)="onTournamentChange()">
          <option value="">-- Select a tournament --</option>
          <option *ngFor="let tournament of tournaments" [value]="tournament.id">
            {{ tournament.name }}
          </option>
        </select>
      </div>
    </div> 

    <div class="event-selector" *ngIf="events.length > 0">
      <label for="event-select">Select Event:</label>
      <div class="event-selector-controls">
        <select id="event-select" [value]="selectedEventId || ''" (change)="onEventChange($event)">
          <option value="">-- Select an event --</option>
          <option *ngFor="let event of events" [value]="event.id">
            {{ event.tournamentName }} - {{ event.name }}
          </option>
        </select>
        <button 
          class="refresh-btn" 
          (click)="refreshSets()" 
          [disabled]="!selectedEventId || isLoadingSets"
          title="Refresh sets">
          <span class="refresh-icon">â†»</span>
        </button>
      </div>
    </div>

    <div *ngIf="isLoadingSets" class="loading">
      <p>Loading sets...</p>
    </div>

    <div *ngIf="!isLoadingSets && selectedEventId" class="match-list">
      <div *ngIf="sets.length === 0" class="no-matches">
        <p>No sets found for this event.</p>
      </div>
      
      <div *ngFor="let set of sets" class="match-card" [class.expanded]="set.isExpanded">
        <div class="match-main" (click)="toggleSet(set.id)">
          <div class="match-header">
            <p class="match-state">{{ getSetState(set.state) }}</p>
          </div>
          
          <div class="match-teams">
            <div class="team" *ngIf="set.slots && set.slots[0]">
              <img 
                src="https://images.start.gg/images/user/642725/image-7515b0f5080d172377aaff65b5b2ea0d.jpg?ehk=Sy44U4Ashnd4eem6krOAjMQBIBfTP1e%2BNFHggZ%2Fg%2B%2FY%3D&ehkOptimized=D2sntIlD5oTqcHJbOCDrg1KJnRWZqPRowbg3qcctLew%3D" 
                [alt]="getEntrantName(set.slots[0])"
                class="team-player-image" />
              <div class="team-info">
                <span class="team-name">
                  {{ getEntrantName(set.slots[0]) }}
                </span>
              </div>
              <span class="team-score-mobile" *ngIf="getScore(set.slots[0]) !== null">{{ getScore(set.slots[0]) }}</span>
            </div>
            <span class="vs">vs</span>
            <div class="team" *ngIf="set.slots && set.slots[1]">
                <span class="team-score-mobile" *ngIf="getScore(set.slots[1]) !== null">{{ getScore(set.slots[1]) }}</span>
              <div class="team-info">
                <span class="team-name">
                  {{ getEntrantName(set.slots[1]) }}
                </span>
              </div>
              <img 
                src="https://images.start.gg/images/user/642725/image-7515b0f5080d172377aaff65b5b2ea0d.jpg?ehk=Sy44U4Ashnd4eem6krOAjMQBIBfTP1e%2BNFHggZ%2Fg%2B%2FY%3D&ehkOptimized=D2sntIlD5oTqcHJbOCDrg1KJnRWZqPRowbg3qcctLew%3D" 
                [alt]="getEntrantName(set.slots[1])"
                class="team-player-image" />
            </div>
          </div>
          
          <div class="match-info">
            <p class="round" *ngIf="set.round">Round {{ set.round }}</p>
            <p class="winner" *ngIf="getWinnerName(set)">
              Winner: {{ getWinnerName(set) }}
            </p>
          </div>
        </div>

        <div class="match-actions" (click)="$event.stopPropagation()">
          <button 
            class="action-btn start-btn" 
            (click)="startSet(set, $event)"
            [disabled]="set.state === 2 || set.state === 3">
            Start
          </button>
          <button 
            class="action-btn reset-btn" 
            (click)="resetSet(set, $event)">
            Reset
          </button>
          <button 
            class="action-btn open-btn" 
            (click)="openInStartGG(set.id, $event)">
            Open in start.gg
          </button>
        </div>

        <div class="match-details" *ngIf="set.isExpanded" (click)="$event.stopPropagation()">
          <h3>Games</h3>
          
          <div *ngIf="loadingSetDetails.has(set.id)" class="loading-games">
            <p>Loading games...</p>
          </div>
          
          <div *ngIf="!loadingSetDetails.has(set.id)" class="games-list">
            <div *ngIf="set.games.length === 0" class="no-games">
              <p>No games found for this set.</p>
            </div>
            
            <div *ngFor="let game of set.games; let i = index" class="game-item">
              <div class="game-header">
                <span class="game-number">Game {{ game.orderNum || (i + 1) }}</span>
                <span class="game-score" *ngIf="game.entrant1Score !== null && game.entrant2Score !== null">
                  {{ game.entrant1Score }} - {{ game.entrant2Score }}
                </span>
              </div>
              
              <div class="game-content">
                <div class="game-entrant" *ngIf="set.slots && set.slots[0]">
                  <div class="character-selector">
                    <button 
                      class="character-btn" 
                      [class.selected]="game.entrant1CharacterId"
                      (click)="openCharacterModal(set, i, 0, $event)"
                      title="Select Character">
                      <img 
                        *ngIf="getSelectedCharacter(set, i, 0)?.imageUrl" 
                        [src]="getSelectedCharacter(set, i, 0)!.imageUrl!" 
                        [alt]="getSelectedCharacter(set, i, 0)!.name"
                        class="character-icon" />
                      <span *ngIf="!getSelectedCharacter(set, i, 0)">ðŸŽ®</span>
                    </button>
                  </div>
                  <span class="entrant-name">{{ getEntrantName(set.slots[0]) }}</span>
                  <button 
                    class="winner-btn" 
                    [class.winner]="isGameWinner(set, i, getEntrantId(set.slots[0]))"
                    (click)="setGameWinner(set, i, getEntrantId(set.slots[0]) || '', $event)"
                    title="Mark as Winner">
                    W
                  </button>
                </div>
                
                <div class="game-vs">vs</div>
                
                <div class="game-entrant" *ngIf="set.slots && set.slots[1]">
                  <div class="character-selector">
                    <button 
                      class="character-btn" 
                      [class.selected]="game.entrant2CharacterId"
                      (click)="openCharacterModal(set, i, 1, $event)"
                      title="Select Character">
                      <img 
                        *ngIf="getSelectedCharacter(set, i, 1)?.imageUrl" 
                        [src]="getSelectedCharacter(set, i, 1)!.imageUrl!" 
                        [alt]="getSelectedCharacter(set, i, 1)!.name"
                        class="character-icon" />
                      <span *ngIf="!getSelectedCharacter(set, i, 1)">ðŸŽ®</span>
                    </button>
                  </div>
                  <span class="entrant-name">{{ getEntrantName(set.slots[1]) }}</span>
                  <button 
                    class="winner-btn" 
                    [class.winner]="isGameWinner(set, i, getEntrantId(set.slots[1]))"
                    (click)="setGameWinner(set, i, getEntrantId(set.slots[1]) || '', $event)"
                    title="Mark as Winner">
                    W
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="game-management">
            <button 
              class="game-action-btn add-game-btn" 
              (click)="addGame(set, $event)">
              Add Game
            </button>
            <button 
              class="game-action-btn delete-game-btn" 
              (click)="deleteGame(set, set.games.length - 1, $event)"
              [disabled]="set.games.length <= 1">
              Delete Game
            </button>
          </div>

          <div class="save-section">
            <button 
              class="save-btn" 
              (click)="saveSet(set, $event)"
              [disabled]="!set.isDirty || savingSetId === set.id">
              {{ savingSetId === set.id ? 'Saving...' : 'Save' }}
            </button>
            <button 
              class="submit-btn" 
              (click)="submitSet(set, $event)">
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!selectedTournamentId && tournaments.length === 0" class="no-events">
      <p>No tournaments found. Make sure you have set your token in the Account page and have tournaments with events.</p>
    </div>
  </div>

  <!-- Backdrop overlay to close modal when clicking outside -->
  <div *ngIf="showCharacterModal && characterModalContext" 
       class="character-modal-backdrop" 
       (click)="closeCharacterModal()"></div>
  
  <!-- Character Selection Modal - Centered on screen -->
  <div *ngIf="showCharacterModal && characterModalContext" 
       class="character-modal-popup"
       (click)="$event.stopPropagation()">
    <div class="character-modal-header">
      <h3>Select Character</h3>
      <button class="close-btn" (click)="closeCharacterModal()">Ã—</button>
    </div>
    <div class="character-modal-content">
      <div *ngIf="characterModalContext.set.availableCharacters && characterModalContext.set.availableCharacters.length > 0" class="characters-grid">
        <button 
          *ngFor="let character of characterModalContext.set.availableCharacters"
          class="character-option"
          [class.selected]="(characterModalContext.entrantIndex === 0 ? characterModalContext.set.games[characterModalContext.gameIndex].entrant1CharacterId : characterModalContext.set.games[characterModalContext.gameIndex].entrant2CharacterId) === character.id"
          (click)="selectCharacter(character.id)">
          <img 
            *ngIf="character.imageUrl" 
            [src]="character.imageUrl" 
            [alt]="character.name"
            class="character-option-icon" />
          <span *ngIf="!character.imageUrl" class="character-option-placeholder">ðŸŽ®</span>
          <span class="character-option-name">{{ character.name }}</span>
        </button>
      </div>
      <div *ngIf="!characterModalContext.set.availableCharacters || characterModalContext.set.availableCharacters.length === 0" class="no-characters">
        <p>No characters available for this game.</p>
      </div>
    </div>
  </div>
</div>
